"use strict";define(["ui","../apis/news","jquery.cookie","jquery.serializeObject"],function(require,exports,module){require("jquery.cookie"),require("jquery.serializeObject");var UI=require("ui"),News=require("../apis/news");$(document).on("click","[data-toggle=fullscreen]",function(e){e.preventDefault(),screenfull.enabled&&screenfull.request()}),$("[data-toggle=popover]").popover(),$(document).on("click",".popover-title .close",function(e){var $target=$(e.target),$popover=$target.closest(".popover").prev();$popover&&$popover.popover("hide")}),$(document).on("click",'[data-toggle="ajaxModal"]',function(e){$("#ajaxModal").remove(),e.preventDefault();var $this=$(this),$remote=$this.data("remote")||$this.attr("href"),$modal=$('<div class="modal fade" id="ajaxModal"><div class="modal-body"></div></div>');$("body").append($modal),$modal.modal(),$modal.load($remote)}),$.fn.dropdown.Constructor.prototype.change=function(e){e.preventDefault();var $select,$menu,$label,$item=$(e.target),$checked=!1;!$item.is("a")&&($item=$item.closest("a")),$menu=$item.closest(".dropdown-menu"),$label=$menu.parent().find(".dropdown-label"),$labelHolder=$label.text(),$select=$item.parent().find("input"),$checked=$select.is(":checked"),$select.is(":disabled")||"radio"==$select.attr("type")&&$checked||("radio"==$select.attr("type")&&$menu.find("li").removeClass("active"),$item.parent().removeClass("active"),!$checked&&$item.parent().addClass("active"),$select.prop("checked",!$select.prop("checked")),$items=$menu.find("li > input:checked"),$items.length?($text=[],$items.each(function(){var $str=$(this).parent().text();$str&&$text.push($.trim($str))}),$text=$text.length<4?$text.join(", "):$text.length+" selected",$label.html($text)):$label.html($label.data("placeholder")))},$(document).on("click.dropdown-menu",".dropdown-select > li > a",$.fn.dropdown.Constructor.prototype.change),$("[data-toggle=tooltip]").tooltip(),$(document).on("click",'[data-toggle^="class"]',function(e){e&&e.preventDefault();var $class,$target,$tmp,$classes,$targets,$this=$(e.target);!$this.data("toggle")&&($this=$this.closest('[data-toggle^="class"]')),$class=$this.data().toggle,$target=$this.data("target")||$this.attr("href"),$class&&($tmp=$class.split(":")[1])&&($classes=$tmp.split(",")),$target&&($targets=$target.split(",")),$classes&&$classes.length&&$.each($targets,function(index,value){if($classes[index].indexOf("*")!==-1){var patt=new RegExp("\\s"+$classes[index].replace(/\*/g,"[A-Za-z0-9-_]+").split(" ").join("\\s|\\s")+"\\s","g");$($this).each(function(i,it){for(var cn=" "+it.className+" ";patt.test(cn);)cn=cn.replace(patt," ");it.className=$.trim(cn)})}"#"!=$targets[index]&&$($targets[index]).toggleClass($classes[index])||$this.toggleClass($classes[index])}),$this.toggleClass("active")}),$(document).on("click",".panel-toggle",function(e){e&&e.preventDefault();var $target,$this=$(e.target),$class="collapse";$this.is("a")||($this=$this.closest("a")),$target=$this.closest(".panel"),$target.find(".panel-body").toggleClass($class),$this.toggleClass("active")}),$(".carousel.auto").carousel(),$(document).on("click.button.data-api","[data-loading-text]",function(e){var $this=$(e.target);$this.is("i")&&($this=$this.parent()),$this.button("loading")});var $window=$(window),mobile=function(option){return"reset"==option?($('[data-toggle^="shift"]').shift("reset"),!0):($('[data-toggle^="shift"]').shift("init"),!0)};$window.width()<768&&mobile();var $resize,$width=$window.width();$window.resize(function(){$width!==$window.width()&&(clearTimeout($resize),$resize=setTimeout(function(){setHeight(),$window.width()<768&&mobile(),$window.width()>=768&&mobile("reset")&&fixVbox(),$width=$window.width()},500))});var setHeight=function(){return $(".app-fluid #nav > *").css("min-height",$(window).height()-60),!0};setHeight();var fixVbox=function(){return $(".ie11 .vbox").each(function(){$(this).height($(this).parent().height())}),!0};fixVbox(),$(document).on("click",'[data-ride="collapse"] a',function(e){var $active,$this=$(e.target);$this.is("a")||($this=$this.closest("a")),$active=$this.parent().siblings(".active"),$active&&$active.toggleClass("active").find("> ul:visible").slideUp(200),$this.parent().hasClass("active")&&$this.next().slideUp(200)||$this.next().slideDown(200),$this.parent().toggleClass("active"),$this.next().is("ul")&&e.preventDefault(),setTimeout(function(){$(document).trigger("updateNav")},300)}),$(document).on("click.bs.dropdown.data-api",".dropdown .on, .dropup .on, .open .on",function(e){e.stopPropagation()}),$(".chosen-select").length&&$(".chosen-select").chosen({no_results_text:"Oops, 未找到匹配项",disable_search_threshold:10}),$(document).on("click","#navbar_toggle, #user_list_toggle",function(){$.cookie("left_sidebar_collapsed",$("#nav").hasClass("nav-xs"),{path:"/"}),$.cookie("right_sidebar_collapsed",$("#aside_user_list").hasClass("nav-xs"),{path:"/"})}),$("#global_search_btn").on("click",function(e){e.preventDefault(),e.stopPropagation();var keyword=$("#global_search_input").val();return keyword?void(location.href="/search/"+keyword):void UI.alert({message:"搜索关键字不能为空~"})}),$("#global_news_form").formValidation({autoFocus:!0,framework:"bootstrap",icon:{valid:!1,invalid:!1,validating:"fa fa-refresh"},row:{valid:"has-success"},fields:{topic:{validators:{notEmpty:{message:"该字段不能为空"}}},content:{validators:{notEmpty:{message:"该字段不能为空"}}}}}).on("success.form.fv",function(e){e.preventDefault();var $form=$(e.target),fv=$form.data("formValidation"),data=$form.serializeObject();News.create(data).then(function(res){res&&res.id?UI.alert({message:"动态发表成功~"}).then(function(){window.location.href="/"}):(UI.alert("动态发表失败，请稍后再试~"),fv.disableSubmitButtons(!1))}).catch(function(err){console.log(err),err&&err.message?UI.alert(err.message):(UI.alert("动态发表失败，请稍后再试~"),fv.disableSubmitButtons(!1))})})});