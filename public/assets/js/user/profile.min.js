"use strict";define(["ui","xtemplate","../apis/user","../apis/news","jquery.serializeObject"],function(require,exports,module){require("jquery.serializeObject");var UI=require("ui"),User=require("../apis/user"),News=require("../apis/news"),Xtemplate=require("xtemplate");$("#profile_form").formValidation({autoFocus:!0,framework:"bootstrap",icon:{valid:!1,invalid:!1,validating:"fa fa-refresh"},err:{container:function($field){return $field.parents(".form-group").find(".help-container")}},row:{valid:"has-success"},fields:{phone:{validators:{notEmpty:{message:"该字段不能为空"},phone:{country:"countrySelectBox",message:"格式不正确"}}},email:{validators:{notEmpty:{message:"该字段不能为空"},regexp:{regexp:"^[^@\\s]+@([^@\\s]+\\.)+[^@\\s]+$",message:"Email格式不正确"}}},workplace:{validators:{}},job:{validators:{}},grade:{validators:{digits:{message:"入学年份，如：2012"}}},major:{validators:{}},qq:{validators:{digits:{message:"只能包含数字"}}},wechat:{validators:{}},blog:{validators:{uri:{message:"必须为合法的URL"}}},github:{validators:{uri:{message:"必须为合法的URL"}}}}}).on("change",'[name="countrySelectBox"]',function(e){$("#profile_form").formValidation("revalidateField","phone")}).on("success.form.fv",function(e){e.preventDefault();var $form=$(e.target),fv=$form.data("formValidation"),userId=$("#user_id").val(),data=$("form").serializeObject();User.update(userId,data).then(function(res){res&&res.id?UI.alert({message:"信息更新成功~"}).then(function(){window.location.href="/users/"+res.id}):(UI.alert("信息保存失败，请稍后再试~"),fv.disableSubmitButtons(!1))}).catch(function(err){err&&err.message?UI.alert(err.message):(UI.alert("信息保存失败，请稍后再试~"),fv.disableSubmitButtons(!1))})}),$("#update_profile").on("click",function(){$("#profile_form").submit()});var pedding=!1,page=1,newsTemplate=$("#news_template").html(),$scrollable=$("#news_scrollable");$scrollable.on("scroll",function(){if(pedding)return!1;var $newsList=$(this).find(".comment-list"),viewHeight=$(this).height(),contentHeight=$(this).get(0).scrollHeight,scrollTop=$(this).scrollTop();return!(contentHeight-viewHeight-scrollTop>200)&&(pedding=!0,void News.getByQuery({page:page+1}).then(function(res){if(res.data&&res.data.length>0){page+=1;var html=new Xtemplate(newsTemplate).render(res.data);$newsList.append(html)}pedding=!1}))})});